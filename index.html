<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 성경 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #F8F7F2; /* Soft Ivory Background */
        }

        /* 화면 전환 효과 */
        .screen {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            width: 100%;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }

        .card {
            background-color: #FFFFFF;
            border: 1px solid #EAEAEA;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        
        .button {
            transition: all 0.2s ease-out;
        }
        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .button:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary { background-color: #206A5D; color: white; } /* Deep Teal */
        .btn-secondary { background-color: #81B29A; color: white; } /* Sage Green */
        .btn-tertiary { background-color: #E0A96D; color: white; } /* Soft Gold */

        .button:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        input[type="text"] {
            border: 2px solid #EAEAEA;
            transition: all 0.3s ease;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #81B29A;
            box-shadow: 0 0 0 3px rgba(129, 178, 154, 0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto max-w-2xl text-center relative">
        <div id="start-screen" class="screen card p-8 rounded-3xl space-y-6">
            <h1 class="text-4xl font-bold mb-2 text-[#2C3E50]">2025 소년부 성경 퀴즈</h1>
            <p class="text-lg text-gray-600">하나님의 말씀을 퀴즈로 재미있게 배워보아요!</p>
            <div class="pt-4 space-y-4">
                <button id="start-quiz-btn" class="button btn-primary font-semibold py-3 px-8 rounded-full text-lg w-full sm:w-auto shadow-md">
                    퀴즈 시작하기
                </button>
                <button id="show-scoreboard-btn" class="button btn-secondary font-semibold py-3 px-8 rounded-full text-lg w-full sm:w-auto shadow-md">
                    스코어보드 보기
                </button>
            </div>
        </div>

        <div id="name-input-screen" class="screen card p-8 rounded-3xl space-y-6 hidden">
            <h2 class="text-3xl font-bold mb-4 text-[#2C3E50]">당신의 이름은 무엇인가요?</h2>
            <p class="text-gray-600">스코어보드에 기록될 이름을 입력해주세요.</p>
            <input type="text" id="username-input" placeholder="이름 입력" class="w-full mt-2 p-4 text-lg rounded-xl text-center">
            <p id="name-error-message" class="text-red-500 font-semibold hidden h-6"></p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="start-btn" class="button btn-primary font-semibold py-3 px-8 rounded-full text-lg shadow-md">
                    시작
                </button>
                <button id="back-from-name-btn" class="button btn-tertiary font-semibold py-3 px-8 rounded-full text-lg shadow-md">
                    뒤로
                </button>
            </div>
        </div>

        <div id="quiz-screen" class="screen card p-8 rounded-3xl space-y-6 hidden">
            <div class="mb-4 text-xl text-gray-700 font-semibold">
                <span id="score-text">문제 1 | 정답 0개</span>
            </div>
            
            <div class="bg-[#F8F7F2] p-6 rounded-xl min-h-[150px] flex items-center justify-center">
                <p id="question-text" class="text-2xl text-gray-800 font-bold leading-relaxed">
                    문제를 불러오는 중...
                </p>
            </div>

            <input type="text" id="user-answer" placeholder="정답을 입력하세요" class="w-full p-4 text-lg rounded-xl text-center">
            
            <p id="result-message" class="text-xl font-bold mt-2 h-8"></p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="submit-btn" class="button btn-secondary font-semibold py-3 px-6 rounded-full text-lg shadow-md">
                    정답 확인
                </button>
                <button id="next-btn" class="button btn-primary font-semibold py-3 px-6 rounded-full text-lg shadow-md">
                    다음 문제
                </button>
                <button id="home-from-quiz-btn" class="button btn-tertiary font-semibold py-3 px-6 rounded-full text-lg shadow-md">
                    그만하기
                </button>
            </div>
        </div>

        <div id="scoreboard-screen" class="screen card p-8 rounded-3xl hidden">
            <h2 class="text-3xl font-bold mb-6 text-[#2C3E50]">🏆 명예의 전당 🏆</h2>
            <div id="save-message" class="text-lg mb-4 h-8"></div>
            <ul id="scoreboard-list" class="space-y-3 text-lg text-gray-800 max-h-96 overflow-y-auto pr-2">
                </ul>
            <button id="home-from-scoreboard-btn" class="button btn-tertiary text-white font-semibold py-3 px-8 rounded-full text-lg shadow-md mt-6">
                홈으로
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 설정 ---
        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
            appId: import.meta.env.VITE_FIREBASE_APP_ID,
            measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
        };        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- UI 요소 ---
        const screens = {
            start: document.getElementById('start-screen'),
            nameInput: document.getElementById('name-input-screen'),
            quiz: document.getElementById('quiz-screen'),
            scoreboard: document.getElementById('scoreboard-screen'),
        };

        const startQuizBtn = document.getElementById('start-quiz-btn');
        const showScoreboardBtn = document.getElementById('show-scoreboard-btn');
        const usernameInput = document.getElementById('username-input');
        const startBtn = document.getElementById('start-btn');
        const backFromNameBtn = document.getElementById('back-from-name-btn');
        const nameErrorMessage = document.getElementById('name-error-message');
        const questionText = document.getElementById('question-text');
        const userAnswerInput = document.getElementById('user-answer');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const resultMessage = document.getElementById('result-message');
        const scoreText = document.getElementById('score-text');
        const homeFromQuizBtn = document.getElementById('home-from-quiz-btn');
        const scoreboardList = document.getElementById('scoreboard-list');
        const homeFromScoreboardBtn = document.getElementById('home-from-scoreboard-btn');
        const saveMessage = document.getElementById('save-message');

        // --- 퀴즈 데이터 ---
        const quizData = [
            { question: "하나님이 천지를 창조하실 때 첫째 날에 창조하신 것은 무엇일까요?", answer: "빛" },
            { question: "아담과 하와가 선악과를 먹은 후 가장 먼저 한 행동은 무엇일까요?", answer: "무화과 잎으로 옷을 만들어 입음" },
            { question: "하나님께서 노아에게 방주를 만들라고 하신 이유는 무엇일까요?", answer: "홍수로 세상을 심판하시기 위해" },
            { question: "아브라함의 아들 중 약속의 자녀로 불린 아들은 누구일까요?", answer: "이삭" },
            { question: "야곱이 형 에서를 피해 도망가던 중 꿈에서 본 것은 무엇이었나요?", answer: "하늘에 닿은 사닥다리" },
            { question: "요셉이 형들에게 팔려간 나라는 어디일까요?", answer: "이집트" },
            { question: "모세가 태어났을 때 어디에 숨겨져 있었나요?", answer: "갈대 상자" },
            { question: "하나님께서 모세를 부르시고 만나실 때 어떤 모습으로 모세와 만나셨나요?", answer: "불타는 떨기나무" },
            { question: "이스라엘 백성들을 풀어주지 않는 애굽을 향하여 하나님이 내리신 마지막 열 번째 재앙은 무엇이었나요?", answer: "장자의 죽음" },
            { question: "하나님께서 홍해를 가르실 때 모세가 사용한 것은 무엇일까요?", answer: "지팡이" },
            { question: "하나님이 광야에서 이스라엘 백성에게 주신 음식은 무엇일까요?", answer: "만나와 메추라기" },
            { question: "하나님이 모세에게 십계명을 어디에서 받게 하셨나요?", answer: "시내산" },
            { question: "광야에서 이스라엘 백성들을 위해 모세가 어떤 행동으로 물을 마시도록 했나요?", answer: "모세가 반석을 쳐서 물이 나오게 함" },
            { question: "모세가 가나안 땅을 정탐하러 보낸 사람은 몇 명이었나요?", answer: "12명" },
            { question: "정탐꾼으로 보낸 12명의 사람 중 하나님을 믿고 믿음의 보고를 한 사람 두 명은 누구일까요?", answer: "여호수아, 갈렙" },
            { question: "모세가 죽은 후 이스라엘 백성을 이끈 지도자는 누구일까요?", answer: "여호수아" },
            { question: "여리고 성은 어떻게 무너졌나요?", answer: "7일 동안 돌고, 마지막 날 소리 지르고 나팔 불 때" },
            { question: "이스라엘의 첫 번째 사사는 누구였을까요?", answer: "옷니엘" },
            { question: "삼손이 모태에서부터 구별되어졌음을 의미하여 하나님의 000이라 말하는데 여기서 000은 무엇인가요?", answer: "나실인" },
            { question: "사무엘은 누구의 아들이었나요?", answer: "엘가나와 한나" },
            { question: "다윗이 골리앗을 무찌른 도구는 무엇일까요?", answer: "물매와 돌" },
            { question: "다윗이 왕이 되기 전 일하던 직업은 무엇이었나요?", answer: "목동 양치기" },
            { question: "이스라엘의 첫 번째 왕은 누구일까요?", answer: "사울" },
            { question: "지혜로운 왕으로 유명한 이스라엘의 세 번째 왕은 누구일까요?", answer: "솔로몬" },
            { question: "솔로몬이 하나님께 가장 먼저 지은 건축물은 무엇이었나요?", answer: "성전" },
            { question: "엘리야가 갈멜산에서 대결한 우상의 선지자는 누구의 선지자였나요?", answer: "바알" },
            { question: "엘리야를 대신해 선지자가 된 사람은 누구일까요?", answer: "엘리사" },
            { question: "하나님께서 요나에게 가라고 하신 도시는 어디였나요?", answer: "니느웨" },
            { question: "요나는 어디로 도망가려 했나요?", answer: "다시스" },
            { question: "다니엘과 세 친구가 바벨론 왕 앞에서 거절한 음식은 무엇이었나요?", answer: "왕의 진미와 포도주" },
            { question: "불 가운데 던져졌으나 살아난 다니엘의 세 친구는 누구였나요?", answer: "사드락, 메삭, 아벳느고" },
            { question: "다니엘이 사자 굴에 던져졌을 때, 사자의 입을 막으신 분은 누구일까요?", answer: "하나님" },
            { question: "에스더가 왕비가 된 나라는 어디였나요?", answer: "페르시아" },
            { question: "에스더의 삼촌 이름은 무엇일까요?", answer: "모르드개" },
            { question: "욥은 어떤 시험을 당했나요?", answer: "재산, 자녀, 건강을 잃음" },
            { question: "시편 대부분을 기록한 사람은 누구일까요?", answer: "다윗" },
            { question: "시편 23편에서 다윗은 여호와를 어떻게 무엇이라고 설명하나요?", answer: "목자" },
            { question: "잠언 대부분을 기록한 왕은 누구일까요?", answer: "솔로몬" },
            { question: "전도서의 주제는 무엇일까요?", answer: "헛되고 헛되다" },
            { question: "이사야 말씀에 여호와께서 이스라엘의 생존자를 남겨두지 않았더라면 어떤 나라처럼 멸망했을 것이라 말하고 있나요?", answer: "소돔과 고모라" },
            { question: "예레미야는 어떤 선지자로 불리나요?", answer: "눈물의 선지자" },
            { question: "에스겔이 본 환상 중 마른 뼈가 살아난 것은 무엇을 의미할까요?", answer: "이스라엘 회복" },
            { question: "스가랴가 예언한 왕은 무엇을 타고 오셨나요?", answer: "나귀 새끼" },
            { question: "미가 선지자가 예언한 메시아가 태어날 곳은 어디일까요?", answer: "베들레헴" },
            { question: "요엘 선지자가 예언한 마지막 날에 하나님이 부어주시는 것은 무엇일까요?", answer: "성령" },
            { question: "아모스는 원래 어떤 직업이었나요?", answer: "목자" },
            { question: "호세아의 결혼 이야기는 무엇을 상징하나요?", answer: "하나님과 이스라엘의 관계" },
            { question: "느헤미야가 다시 세운 것은 무엇일까요?", answer: "예루살렘 성벽" },
            { question: "학개 선지자가 백성에게 건축하라고 한 것은 무엇이었나요?", answer: "성전" },
            { question: "말라기는 구약 성경의 몇 번째 책일까요?", answer: "39번째 (마지막 책)" },
            { question: "구약 성경은 총 몇 권일까요?", answer: "39권" },
            { question: "예수님의 어머니 이름은 무엇일까요?", answer: "마리아" },
            { question: "예수님의 아버지로 불린 사람은 누구일까요?", answer: "요셉" },
            { question: "예수님이 태어나신 곳은 어디일까요?", answer: "베들레헴" },
            { question: "예수님이 자라신 마을은 어디일까요?", answer: "나사렛" },
            { question: "예수님이 세례받으신 강은 어디일까요?", answer: "요단강" },
            { question: "예수님께 세례를 준 사람은 누구일까요?", answer: "세례 요한" },
            { question: "예수님이 광야에서 시험을 받으신 기간은 며칠일까요?", answer: "40일" },
            { question: "예수님의 첫 번째 제자는 누구였을까요?", answer: "베드로와 안드레" },
            { question: "예수님의 열두 제자 중 세리였던 사람은 누구일까요?", answer: "마태" },
            { question: "예수님이 첫 번째로 행하신 기적은 무엇일까요?", answer: "가나 혼인잔치 물로 포도주 만듦" },
            { question: "예수님이 죽은 나사로를 살리셨을 때, 나사로는 며칠 동안 무덤에 있었나요?", answer: "4일" },
            { question: "예수님이 오병이어 기적을 행하셨을 때, 사용된 것은 무엇일까요?", answer: "보리떡 5개와 물고기 2마리" },
            { question: "오병이어 기적으로 먹은 사람은 몇 명이었나요? (남자만 세었을 때)", answer: "5천 명" },
            { question: "예수님이 폭풍을 잠잠하게 하신 곳은 어디일까요?", answer: "갈릴리 바다" },
            { question: "예수님이 물 위를 걸으신 사건은 어디서 일어났나요?", answer: "갈릴리 바다" },
            { question: "예수님이 제자들에게 가르쳐주신 기도는 무엇일까요?", answer: "주기도문" },
            { question: "예수님이 설교하신 산상수훈의 기록된 복음서는 어디일까요?", answer: "마태복음" },
            { question: "예수님이 변화산에서 함께 하신 제자 세 명은 누구였나요?", answer: "베드로, 야고보, 요한" },
            { question: "예수님이 예루살렘에 입성하실 때 타신 것은 무엇일까요?", answer: "나귀 새끼" },
            { question: "예수님이 마지막 만찬에서 떡과 잔이 의미하는 것은 무엇일까요?", answer: "예수님의 몸과 피" },
            { question: "예수님을 세 번 부인한 제자는 누구일까요?", answer: "베드로" },
            { question: "예수님을 은 삼십에 팔아넘긴 제자는 누구일까요?", answer: "가룟 유다" },
            { question: "예수님이 십자가에 달리신 언덕 이름은 무엇일까요?", answer: "골고다" },
            { question: "요한복음에서 예수님이 십자가에 못 박히실 때 하신 말씀 중 하나는 무엇일까요?", answer: "다 이루었다" },
            { question: "예수님이 부활하신 날은 무슨 요일일까요?", answer: "주일 (안식 후 첫날)" },
            { question: "예수님이 부활하신 후 몇일 동안 제자들과 함께 계셨나요?", answer: "40일" },
            { question: "성령이 처음 강림한 날은 언제였나요?", answer: "오순절" },
            { question: "오순절 성령 강림 후 제자들이 한 일은 무엇일까요?", answer: "방언으로 복음을 전함" },
            { question: "사도행전에서 볼 수 있는 초대 교회의 첫 순교자는 누구일까요?", answer: "스데반" },
            { question: "사울이 다메섹 도상에서 만난 분은 누구일까요?", answer: "예수님" },
            { question: "사울의 이름이 바울로 바뀐 후 주로 전한 대상은 누구였나요?", answer: "이방인" },
            { question: "바울과 함께 1차 선교여행을 간 동료는 누구일까요?", answer: "바나바" },
            { question: "빌립이 전도한 에디오피아 내시는 무엇을 읽고 있었나요?", answer: "이사야서 말씀" },
            { question: "바울과 실라가 감옥에서 한 일은 무엇이었나요?", answer: "찬송과 기도" },
            { question: "바울이 편지를 가장 많이 보낸 교회는 어디였나요?", answer: "고린도 교회" },
            { question: "바울이 마지막으로 간 도시는 어디였나요?", answer: "로마" },
            { question: "신약 성경 전체는 몇 권일까요?", answer: "27권" },
            { question: "신구약 성경 전체는 몇 권일까요?", answer: "66권" },
            { question: "사랑장이라고 불리는 장은 어디일까요?", answer: "고린도전서 13장" },
            { question: "성령의 열매는 몇 가지일까요?", answer: "9가지" },
            { question: "믿음의 조상이라고 불리는 사람은 누구일까요?", answer: "아브라함" },
            { question: "하나님의 전신갑주는 어디에 나와 있나요?", answer: "에베소서 6:10-18" },
            { question: "나는 선한 목자라라고 말씀하신 분은 누구일까요?", answer: "예수님" },
            { question: "예수님을 말씀이라고 소개하는 복음서는 무엇일까요?", answer: "요한복음" },
            { question: "항상 기뻐하라 쉬지 말고 기도하라 범사에 감사하라가 나오는 곳은?", answer: "데살로니가전서 5:16-18" },
            { question: "야고보서가 강조하는 것은 무엇일까요?", answer: "행함 있는 믿음" },
            { question: "요한계시록에 나오는 일곱 교회 중 하나를 말해보세요.", answer: "에베소, 서머나, 버가모, 두아디라, 사데, 빌라델비아, 라오디게아" },
            { question: "요한계시록에서 새 하늘과 새 땅에 들어가는 사람들은 누구일까요?", answer: "어린 양의 생명책에 기록된 자들" },
            { question: "요한계시록을 기록한 요한은 어느 섬에서 하나님께 계시를 받았나요?", answer: "밧모섬" }
        ];

        // --- 전역 변수 및 상태 관리 ---
        let db, auth;
        let userId = 'anonymous';
        let userName = '';
        let currentQuestionIndex = 0;
        let attemptedCount = 0;
        let correctCount = 0;
        let questionOrder = [];
        let unsubscribeScoreboard = null;

        // --- 함수 ---

        // Firebase 초기화
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
            } catch (e) {
                console.error("Firebase 초기화 오류:", e);
                alert("서비스에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.");
            }
        };

        // 화면 전환 함수
        function switchScreen(hideKey, showKey) {
            const hideEl = screens[hideKey];
            const showEl = screens[showKey];

            if (hideEl) {
                hideEl.classList.add('hidden');
            }
            if (showEl) {
                showEl.classList.remove('hidden');
            }
        }
        
        // 배열 무작위 섞기 (Fisher-Yates Shuffle)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // 정답 문자열 정규화 (공백, 특수문자, 조사 제거)
        function normalizeAnswer(answer) {
            if (typeof answer !== 'string') return '';
            return answer.replace(/\([^)]*\)/g, '')
                         .replace(/[은는이가을를의\s,./]/g, '') // 공백, 쉼표, 슬래시 등도 제거
                         .toLowerCase()
                         .trim();
        }

        // 퀴즈 상태 초기화
        function resetQuizState() {
            currentQuestionIndex = 0;
            attemptedCount = 0;
            correctCount = 0;
            questionOrder = [...Array(quizData.length).keys()];
            shuffle(questionOrder);

            updateScoreUI();
            userAnswerInput.value = '';
            userAnswerInput.disabled = false;
            submitBtn.disabled = false;
            nextBtn.disabled = true;
            resultMessage.textContent = '';
        }

        // 점수 UI 업데이트
        function updateScoreUI() {
            scoreText.textContent = `문제 ${attemptedCount + 1} | 정답 ${correctCount}개`;
        }
        
        // 다음 문제 로드 또는 퀴즈 종료
        function loadNextQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                endQuiz();
                return;
            }
            const questionIndex = questionOrder[currentQuestionIndex];
            const currentQuestion = quizData[questionIndex];
            questionText.textContent = currentQuestion.question;

            userAnswerInput.value = "";
            userAnswerInput.disabled = false;
            submitBtn.disabled = false;
            nextBtn.disabled = true;
            resultMessage.textContent = "";
            resultMessage.className = "text-xl font-bold mt-2 h-8"; // 클래스 초기화
            updateScoreUI();
            userAnswerInput.focus();
        }

        // 정답 확인 로직 (개선됨)
        function checkAnswer() {
            if (submitBtn.disabled) return;

            const currentQuestion = quizData[questionOrder[currentQuestionIndex]];
            const userAnswer = userAnswerInput.value;
            
            // 정답을 배열로 변환 (쉼표, 슬래시, 공백 기준)
            const correctAnswers = currentQuestion.answer.split(/[,/\s]+/).map(normalizeAnswer).filter(Boolean);
            // 사용자 답을 배열로 변환
            const userAnswers = userAnswer.split(/[,/\s]+/).map(normalizeAnswer).filter(Boolean);
            
            // 정렬 후 비교하여 순서에 상관없이 정답 처리
            const isCorrect = correctAnswers.length === userAnswers.length && 
                              correctAnswers.sort().every((val, i) => val === userAnswers.sort()[i]);

            attemptedCount++;
            
            if (isCorrect) {
                correctCount++;
                resultMessage.textContent = "정답입니다! 🎉";
                resultMessage.className = "text-xl font-bold mt-2 h-8 text-green-600";
            } else {
                resultMessage.textContent = `아쉬워요! 정답: "${currentQuestion.answer}"`;
                resultMessage.className = "text-xl font-bold mt-2 h-8 text-red-600";
            }
            
            userAnswerInput.disabled = true;
            submitBtn.disabled = true;
            nextBtn.disabled = false;
            currentQuestionIndex++;
            updateScoreUI();
        }
        
        // 퀴즈 종료 처리
        async function endQuiz() {
            switchScreen('quiz', 'scoreboard'); // ### FIX: 화면 전환 코드 추가
            const saveStatus = await saveScore();
            loadScoreboard(saveStatus);
        }

        // 점수 저장
        async function saveScore() {
            if (!db || attemptedCount < 10) return "not_enough_questions";
            
            const scoreData = {
                name: userName,
                score: correctCount,
                timestamp: new Date(),
                questionsAnswered: attemptedCount,
                userId: userId
            };
            
            try {
                const scoreCollectionRef = collection(db, "quiz_scores");
                const userScoreRef = doc(scoreCollectionRef, userId);
                await setDoc(userScoreRef, scoreData, { merge: true });
                return "success";
            } catch (e) {
                console.error("점수 저장 실패:", e);
                return "error";
            }
        }

        // 스코어보드 로드
        function loadScoreboard(status) {
            switch(status) {
                case "success":
                    saveMessage.innerHTML = `🎉 <b>${correctCount}점</b>을 획득하여 점수를 등록했어요! 🎉`;
                    saveMessage.className = "text-lg mb-4 h-8 text-green-600";
                    break;
                case "not_enough_questions":
                    saveMessage.textContent = "퀴즈를 10문제 이상 풀어야 점수가 등록됩니다.";
                    saveMessage.className = "text-lg mb-4 h-8 text-yellow-600";
                    break;
                case "error":
                     saveMessage.textContent = "점수 등록에 실패했어요. 다시 시도해주세요.";
                    saveMessage.className = "text-lg mb-4 h-8 text-red-600";
                    break;
                default:
                    saveMessage.textContent = "";
            }

            if (!db) return;
            
            // 기존 리스너가 있다면 해제
            if (unsubscribeScoreboard) unsubscribeScoreboard();

            const scoreCollectionRef = collection(db, "quiz_scores");
            unsubscribeScoreboard = onSnapshot(query(scoreCollectionRef), (snapshot) => {
                const scores = snapshot.docs.map(doc => doc.data());
                scores.sort((a, b) => b.score - a.score || a.timestamp - b.timestamp); // 점수 같으면 시간순

                scoreboardList.innerHTML = '';
                if (scores.length === 0) {
                    scoreboardList.innerHTML = `<li class="text-gray-500">아직 등록된 점수가 없어요.</li>`;
                } else {
                    scores.forEach((score, index) => {
                        const li = document.createElement('li');
                        const isCurrentUser = score.userId === userId;
                        li.className = `p-3 rounded-lg flex justify-between items-center ${isCurrentUser ? 'font-bold bg-yellow-100' : 'bg-gray-50'}`;
                        li.innerHTML = `
                            <span class="flex items-center">
                                <span class="w-8 text-left">${index + 1}.</span>
                                <span>${score.name}</span>
                            </span>
                            <span>${score.score}점 (${score.questionsAnswered}문제)</span>`;
                        scoreboardList.appendChild(li);
                    });
                }
            });
        }

        // --- 이벤트 리스너 ---

        startQuizBtn.addEventListener('click', () => switchScreen('start', 'nameInput'));

        showScoreboardBtn.addEventListener('click', () => {
            switchScreen('start', 'scoreboard');
            loadScoreboard();
        });
        
        startBtn.addEventListener('click', () => {
            const name = usernameInput.value.trim();
            if (name) {
                userName = name;
                switchScreen('nameInput', 'quiz');
                resetQuizState();
                loadNextQuestion();
            } else {
                nameErrorMessage.textContent = "이름을 꼭 입력해주세요!";
                nameErrorMessage.classList.remove('hidden');
            }
        });

        backFromNameBtn.addEventListener('click', () => switchScreen('nameInput', 'start'));

        submitBtn.addEventListener('click', checkAnswer);
        
        nextBtn.addEventListener('click', loadNextQuestion);
        
        homeFromQuizBtn.addEventListener('click', endQuiz);
        
        homeFromScoreboardBtn.addEventListener('click', () => {
            if (unsubscribeScoreboard) unsubscribeScoreboard(); // 리스너 정리
            switchScreen('scoreboard', 'start');
        });
        
        userAnswerInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (!submitBtn.disabled) {
                    submitBtn.click();
                } else if (!nextBtn.disabled) {
                    nextBtn.click();
                }
            }
        });

        // 페이지 로드 시 Firebase 초기화
        window.onload = initializeFirebase;
    </script>
</body>
</html>
